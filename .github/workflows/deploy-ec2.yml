name: deploy to EC2

on:
  push:
     branches:
        - main

env:
    DEPLOY_PATH: /home/${{ secrets.EC2_USERNAME}}/book-api

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
           - name: checkout code
             uses: actions/checkout@v3
           - name: Setup Node.js
             uses: actions/setup-node@v3
             with: 
               node-version: 20
            
           - name: Install dependencies
             run: npm ci


           - name: Build Typescript Project 
             run: npm run build
           - name: Check SSH connection
             uses: appleboy/ssh-action@master
             with:
                host: ${{ secrets.EC2_HOST}}
                username: ${{ secrets.EC2_USERNAME}}
                key: ${{ secrets.EC2_PRIVATE_KEY}}
                script: |
                    echo "SSH connection successful"
                    whoami

                
           - name: Create target directory
             uses: appleboy/ssh-action@master
             with:
               host: ${{ secrets.EC2_HOST }}
               username: ${{ secrets.EC2_USERNAME }}
               key: ${{ secrets.EC2_PRIVATE_KEY }}
               script: |
                  sudo mkdir -p ${{ env.DEPLOY_PATH }}
                  sudo chown -R ${{ secrets.EC2_USERNAME }}:${{ secrets.EC2_USERNAME }} ${{ env.DEPLOY_PATH }}

           - name: Deploy to EC2
             uses: appleboy/scp-action@master
             with:
               host: ${{ secrets.EC2_HOST }}
               username: ${{ secrets.EC2_USERNAME }}
               key: ${{ secrets.EC2_PRIVATE_KEY }}
               source: "dist,package.json,package-lock.json"
               target: ${{ env.DEPLOY_PATH }}
               strip_components: 1
               overwrite: true

           - name: Upload environment variables
             uses: appleboy/ssh-action@master
             with:
               host: ${{ secrets.EC2_HOST }}
               username: ${{ secrets.EC2_USERNAME }}
               key: ${{ secrets.EC2_PRIVATE_KEY }}
               script: |
                echo "${{ secrets.ENV_FILE }}" > ${{ env.DEPLOY_PATH }}/.env

           - name: Setup and run application
             uses: appleboy/ssh-action@master
             with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USERNAME }}
              key: ${{ secrets.EC2_PRIVATE_KEY }}
              script: |
                export NVM_DIR="/home/${{ secrets.EC2_USERNAME }}/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                cd ${{ env.DEPLOY_PATH }}
                which pm2 || npm install -g pm2
                pm2 reload dist/main.js --name book-api || pm2 start dist/main.js --name book-api

           - name: Post Setup Node.js
             uses: appleboy/ssh-action@master
             with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USERNAME }}
              key: ${{ secrets.EC2_PRIVATE_KEY }}
              script: |
               cd ${{ env.DEPLOY_PATH }}
               pm2 status